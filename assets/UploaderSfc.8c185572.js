import{F as fe,u as pe}from"./provide.7023c847.js";import{I as ge}from"./index.0f4fa8c0.js";import{P as ce}from"./popup.e2065a98.js";import{I as ye}from"./imagePreview.6fad4e43.js";import{v as he}from"./index.83f7859b.js";import{d as we,a as U,b as j,X as be,w as Ve,p as A,ai as Re,f as h,h as w,M as R,F as Pe,ak as Ce,D as G,N as s,Q as Be,aj as ke,q as P,j as C,R as Fe,O as Se,S as De,W as q,r as L,n as Te,Z as Q}from"./vue-router.esm-bundler.0f5b2940.js";import{u as Ue,a as b,B as X,C as Z,c as Ae}from"./shared.8d2d74f2.js";var Le={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:{type:Function},onAfterRead:{type:Function},onBeforeRemove:{type:Function},onRemove:{type:Function},onOversize:{type:Function},"onUpdate:modelValue":{type:Function}};function J(e,o,m,f,p,l,r){try{var u=e[l](r),g=u.value}catch(B){m(B);return}u.done?o(g):Promise.resolve(g).then(f,p)}function K(e){return function(){var o=this,m=arguments;return new Promise(function(f,p){var l=e.apply(o,m);function r(g){J(l,f,p,r,u,"next",g)}function u(g){J(l,f,p,r,u,"throw",g)}r(void 0)})}}var{n:Ne,classes:ze}=Ae("uploader"),Me=0,$e=["onClick"],Ie=["onClick"],We=["src","alt"],Ee=["multiple","accept","capture","disabled"],He=["src"];function Oe(e,o){var m=A("var-icon"),f=A("var-form-details"),p=A("var-popup"),l=Re("ripple");return h(),w("div",{class:s(e.classes(e.n(),"var--box"))},[R("div",{class:s(e.n("file-list"))},[(h(!0),w(Pe,null,Ce(e.files,r=>G((h(),w("div",{class:s(e.classes(e.n("file"),"var-elevation--2",[r.state==="loading",e.n("--loading")])),key:r.id,onClick:u=>e.preview(r)},[R("div",{class:s(e.n("file-name"))},Be(r.name||r.url),3),e.removable?(h(),w("div",{key:0,class:s(e.n("file-close")),onClick:ke(u=>e.handleRemove(r),["stop"])},[P(m,{class:s(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ie)):C("v-if",!0),r.cover?(h(),w("img",{key:1,class:s(e.n("file-cover")),style:Fe({objectFit:r.fit}),src:r.cover,alt:r.name},null,14,We)):C("v-if",!0),R("div",{class:s(e.classes(e.n("file-indicator"),[r.state==="success",e.n("--success")],[r.state==="error",e.n("--error")]))},null,2)],10,$e)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?G((h(),w("div",{key:0,class:s(e.classes([!e.$slots.default,e.n("action")+" var-elevation--2"],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:o[1]||(o[1]=function(){return e.triggerAction&&e.triggerAction(...arguments)})},[R("input",{ref:"input",class:s(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:o[0]||(o[0]=function(){return e.handleChange&&e.handleChange(...arguments)})},null,42,Ee),Se(e.$slots,"default",{},()=>[P(m,{class:s(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):C("v-if",!0)],2),P(f,{"error-message":e.errorMessage,"maxlength-text":e.maxlengthText},null,8,["error-message","maxlength-text"]),P(p,{class:s(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":o[2]||(o[2]=r=>e.showPreview=r),onClosed:o[3]||(o[3]=r=>e.currentPreview=null)},{default:De(()=>{var r,u;return[e.currentPreview&&e.isHTMLSupportVideo((r=e.currentPreview)==null?void 0:r.url)?(h(),w("video",{key:0,class:s(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(u=e.currentPreview)==null?void 0:u.url},null,10,He)):C("v-if",!0)]}),_:1},8,["class","show"])],2)}const N=we({render:Oe,name:"VarUploader",directives:{Ripple:he},components:{VarIcon:ge,VarPopup:ce,VarFormDetails:fe},props:Le,setup(e){var o=U(null),m=U(!1),f=U(null),p=j(()=>{var{maxlength:a,modelValue:{length:n}}=e;return be(a)?n+" / "+a:""}),{form:l,bindForm:r}=pe(),{errorMessage:u,validateWithTrigger:g,validate:B,resetValidation:k}=Ue(),Y=j(()=>{var{modelValue:a,hideList:n}=e;return n?[]:a}),x=()=>{o.value.click()},_=a=>{var{disabled:n,readonly:i,previewed:t}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||n||i||!t)){var{url:d}=a;if(q(d)&&Z(d)){ye(d);return}q(d)&&X(d)&&(f.value=a,m.value=!0)}},ee=a=>({id:Me++,url:"",cover:"",name:a.name,file:a}),ae=a=>{var n=a.target,{files:i}=n;return Array.from(i)},re=a=>new Promise(n=>{var i=new FileReader;i.onload=()=>{var t=i.result;a.file.type.startsWith("image")&&(a.cover=t),a.url=t,n(a)},i.readAsDataURL(a.file)}),le=a=>a.map(re),ne=a=>{var{onBeforeRead:n}=e;return a.map(i=>new Promise(t=>{var d=n?n(L(i)):!0;Promise.resolve(d).then(V=>t({valid:V,varFile:i}))}))},ie=function(){var a=K(function*(n){var{maxsize:i,maxlength:t,modelValue:d,onOversize:V,onAfterRead:S,readonly:D,disabled:T}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||T||D)){var se=v=>v.filter(c=>c.file.size>Q(i)?(b(V,L(c)),!1):!0),ue=v=>{var c=Math.min(v.length,Q(t)-d.length);return v.slice(0,c)},de=ae(n),y=de.map(ee);y=i!=null?se(y):y,y=t!=null?ue(y):y;var ve=yield Promise.all(le(y)),me=yield Promise.all(ne(ve)),O=me.filter(v=>{var{valid:c}=v;return c}).map(v=>{var{varFile:c}=v;return c});b(e["onUpdate:modelValue"],[...d,...O]),n.target.value="",O.forEach(v=>b(S,L(v)))}});return function(i){return a.apply(this,arguments)}}(),oe=function(){var a=K(function*(n){var{disabled:i,readonly:t,modelValue:d,onBeforeRemove:V,onRemove:S}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||i||t)&&!(V&&!(yield V(n)))){var D=d.filter(T=>T!==n);b(S,n),W("onRemove"),b(e["onUpdate:modelValue"],D)}});return function(i){return a.apply(this,arguments)}}(),z=()=>e.modelValue.filter(a=>a.state==="success"),M=()=>e.modelValue.filter(a=>a.state==="error"),$=()=>e.modelValue.filter(a=>a.state==="loading"),I={getSuccess:z,getError:M,getLoading:$},W=a=>{Te(()=>{var{validateTrigger:n,rules:i,modelValue:t}=e;g(n,a,i,t,I)})},F=!1,E=()=>B(e.rules,e.modelValue,I),H=()=>{F=!0,b(e["onUpdate:modelValue"],[]),k()},te={validate:E,resetValidation:k,reset:H};return b(r,te),Ve(()=>e.modelValue,()=>{!F&&W("onChange"),F=!1},{deep:!0}),{n:Ne,classes:ze,input:o,files:Y,showPreview:m,currentPreview:f,errorMessage:u,maxlengthText:p,isHTMLSupportVideo:X,isHTMLSupportImage:Z,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,preview:_,triggerAction:x,handleChange:ie,handleRemove:oe,getSuccess:z,getError:M,getLoading:$,validate:E,resetValidation:k,reset:H}}});N.install=function(e){e.component(N.name,N)};export{N as U};
