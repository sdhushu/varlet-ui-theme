import{F as he,u as we}from"./provide-284e6af5.js";import{I as be}from"./index-b7440cdf.js";import{P as Ve}from"./popup-2811b8cc.js";import{I as q}from"./imagePreview-4faadb71.js";import{v as Re}from"./index-dfe18fd8.js";import{d as Pe,a as N,b as Q,X as Ce,w as Be,p as z,ag as Se,f as b,h as V,M as k,F as ke,ai as De,D as X,N as d,Q as Fe,ah as Le,q as D,j as F,R as Te,O as Ue,S as $e,W as Z,n as Ne,r as S,Z as J,as as K}from"./vue-router.esm-bundler-a6d65396.js";import{a as P,j as ze,e as p,G as Y,H as _,c as Ae}from"./shared-083249af.js";var Me={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:P(),onAfterRead:P(),onBeforeRemove:P(),onRemove:P(),onOversize:P(),"onUpdate:modelValue":P()};function x(e,s,v,m,g,l,r){try{var u=e[l](r),c=u.value}catch(L){v(L);return}u.done?s(c):Promise.resolve(c).then(m,g)}function ee(e){return function(){var s=this,v=arguments;return new Promise(function(m,g){var l=e.apply(s,v);function r(c){x(l,m,g,r,u,"next",c)}function u(c){x(l,m,g,r,u,"throw",c)}r(void 0)})}}var{n:Ie,classes:He}=Ae("uploader"),We=0,Ee=["onClick"],Ge=["onClick"],Oe=["src","alt"],je=["multiple","accept","capture","disabled"],qe=["src"];function Qe(e,s){var v=z("var-icon"),m=z("var-form-details"),g=z("var-popup"),l=Se("ripple");return b(),V("div",{class:d(e.classes(e.n(),e.n("$--box")))},[k("div",{class:d(e.n("file-list"))},[(b(!0),V(ke,null,De(e.files,r=>X((b(),V("div",{class:d(e.classes(e.n("file"),e.n("$-elevation--2"),[r.state==="loading",e.n("--loading")])),key:r.id,onClick:u=>e.preview(r)},[k("div",{class:d(e.n("file-name"))},Fe(r.name||r.url),3),e.removable?(b(),V("div",{key:0,class:d(e.n("file-close")),onClick:Le(u=>e.handleRemove(r),["stop"])},[D(v,{class:d(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ge)):F("v-if",!0),r.cover?(b(),V("img",{key:1,class:d(e.n("file-cover")),style:Te({objectFit:r.fit}),src:r.cover,alt:r.name},null,14,Oe)):F("v-if",!0),k("div",{class:d(e.classes(e.n("file-indicator"),[r.state==="success",e.n("--success")],[r.state==="error",e.n("--error")]))},null,2)],10,Ee)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?X((b(),V("div",{key:0,class:d(e.classes([!e.$slots.default,e.n("action")+" "+e.n("$-elevation--2")],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:s[1]||(s[1]=function(){return e.chooseFile&&e.chooseFile(...arguments)})},[k("input",{ref:"input",type:"file",class:d(e.n("action-input")),multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:s[0]||(s[0]=function(){return e.handleChange&&e.handleChange(...arguments)})},null,42,je),Ue(e.$slots,"default",{},()=>[D(v,{class:d(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):F("v-if",!0)],2),D(m,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),D(g,{class:d(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":s[2]||(s[2]=r=>e.showPreview=r),onClosed:s[3]||(s[3]=r=>e.currentPreview=null)},{default:$e(()=>{var r,u;return[e.currentPreview&&e.isHTMLSupportVideo((r=e.currentPreview)==null?void 0:r.url)?(b(),V("video",{key:0,class:d(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(u=e.currentPreview)==null?void 0:u.url},null,10,qe)):F("v-if",!0)]}),_:1},8,["class","show"])],2)}var ae=Pe({name:"VarUploader",directives:{Ripple:Re},components:{VarIcon:be,VarPopup:Ve,VarFormDetails:he},props:Me,setup(e){var s=N(null),v=N(!1),m=N(null),g=Q(()=>{var{maxlength:a,modelValue:{length:n}}=e;return Ce(a)?n+" / "+a:""}),{form:l,bindForm:r}=we(),{errorMessage:u,validateWithTrigger:c,validate:L,resetValidation:T}=ze(),re=Q(()=>{var{modelValue:a,hideList:n}=e;return n?[]:a}),le=a=>{var{disabled:n,readonly:i,previewed:t}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||n||i||!t)){var{url:o}=a;if(Z(o)&&_(o)){q(o);return}Z(o)&&Y(o)&&(m.value=a,v.value=!0)}},ne=a=>({id:We++,url:"",cover:"",name:a.name,file:a}),ie=a=>{var n=a.target,{files:i}=n;return Array.from(i)},oe=a=>new Promise(n=>{var i=new FileReader;i.onload=()=>{var t=i.result;a.file.type.startsWith("image")&&(a.cover=t),a.url=t,n(a)},i.readAsDataURL(a.file)}),se=a=>a.map(oe),te=a=>{var{onBeforeRead:n}=e;return a.map(i=>new Promise(t=>{n||t({valid:!0,varFile:i});var o=p(n,S(i));o=K(o)?o:[o],Promise.all(o).then(R=>{t({valid:!R.some(C=>!C),varFile:i})})}))},de=function(){var a=ee(function*(n){var{maxsize:i,maxlength:t,modelValue:o,onOversize:R,onAfterRead:C,readonly:h,disabled:$}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||$||h)){var B=f=>f.filter(y=>y.file.size>J(i)?(p(R,S(y)),!1):!0),pe=f=>{var y=Math.min(f.length,J(t)-o.length);return f.slice(0,y)},ge=ie(n),w=ge.map(ne);w=i!=null?B(w):w,w=t!=null?pe(w):w;var ce=yield Promise.all(se(w)),ye=yield Promise.all(te(ce)),j=ye.filter(f=>{var{valid:y}=f;return y}).map(f=>{var{varFile:y}=f;return y});p(e["onUpdate:modelValue"],[...o,...j]),n.target.value="",j.forEach(f=>p(C,S(f)))}});return function(i){return a.apply(this,arguments)}}(),ue=function(){var a=ee(function*(n){var{disabled:i,readonly:t,modelValue:o,onBeforeRemove:R,onRemove:C}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||i||t)){if(R){var h=p(R,S(n));if(h=K(h)?h:[h],(yield Promise.all(h)).some(B=>!B))return}var $=o.filter(B=>B!==n);p(C,S(n)),E("onRemove"),p(e["onUpdate:modelValue"],$)}});return function(i){return a.apply(this,arguments)}}(),M=()=>e.modelValue.filter(a=>a.state==="success"),I=()=>e.modelValue.filter(a=>a.state==="error"),H=()=>e.modelValue.filter(a=>a.state==="loading"),ve=()=>{s.value.click()},me=()=>{m.value=null,v.value=!1,q.close()},W={getSuccess:M,getError:I,getLoading:H},E=a=>{Ne(()=>{var{validateTrigger:n,rules:i,modelValue:t}=e;c(n,a,i,t,W)})},U=!1,G=()=>L(e.rules,e.modelValue,W),O=()=>{U=!0,p(e["onUpdate:modelValue"],[]),T()},fe={validate:G,resetValidation:T,reset:O};return p(r,fe),Be(()=>e.modelValue,()=>{!U&&E("onChange"),U=!1},{deep:!0}),{n:Ie,classes:He,input:s,files:re,showPreview:v,currentPreview:m,errorMessage:u,maxlengthText:g,isHTMLSupportVideo:Y,isHTMLSupportImage:_,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,preview:le,handleChange:de,handleRemove:ue,getSuccess:M,getError:I,getLoading:H,validate:G,resetValidation:T,reset:O,chooseFile:ve,closePreview:me}}});ae.render=Qe;const A=ae;A.install=function(e){e.component(A.name,A)};export{A as U};
