import{F as ge,u as ce}from"./provide.deebc008.js";import{I as ye}from"./index.8b6b6a08.js";import{P as he}from"./popup.85f9f6fe.js";import{I as we}from"./imagePreview.b08ef9c0.js";import{v as be}from"./index.38f8c4d5.js";import{d as Ve,a as F,b as q,w as Re,p as N,ai as Pe,f as b,h as V,M as S,F as Ce,ak as ke,D as Q,N as d,Q as Be,aj as Se,q as D,j as T,R as De,O as Te,S as Ue,r as B,n as Ae}from"./vue-router.esm-bundler.d85fe05e.js";import{a as P,j as Le,u as $e,e as p,T as J,U as K,c as Fe,h as X,l as Y,g as Z}from"./shared.33d42a23.js";var Ne={modelValue:{type:Array,default:()=>[]},accept:{type:String,default:"image/*"},capture:{type:[String,Boolean],default:void 0},multiple:{type:Boolean,default:!1},readonly:{type:Boolean,default:!1},disabled:{type:Boolean,default:!1},removable:{type:Boolean,default:!0},maxlength:{type:[Number,String]},maxsize:{type:[Number,String]},previewed:{type:Boolean,default:!0},ripple:{type:Boolean,default:!0},validateTrigger:{type:Array,default:()=>["onChange","onRemove"]},rules:{type:Array},hideList:{type:Boolean,default:!1},onBeforeRead:P(),onAfterRead:P(),onBeforeRemove:P(),onRemove:P(),onOversize:P(),"onUpdate:modelValue":P()};function x(e,s,m,f,g,l,r){try{var u=e[l](r),c=u.value}catch(U){m(U);return}u.done?s(c):Promise.resolve(c).then(f,g)}function _(e){return function(){var s=this,m=arguments;return new Promise(function(f,g){var l=e.apply(s,m);function r(c){x(l,f,g,r,u,"next",c)}function u(c){x(l,f,g,r,u,"throw",c)}r(void 0)})}}var{n:ze,classes:Me}=Fe("uploader"),Ie=0,je=["onClick"],Ee=["onClick"],He=["src","alt"],Oe=["multiple","accept","capture","disabled"],We=["src"];function Ge(e,s){var m=N("var-icon"),f=N("var-form-details"),g=N("var-popup"),l=Pe("ripple");return b(),V("div",{class:d(e.classes(e.n(),e.n("$--box")))},[S("div",{class:d(e.n("file-list"))},[(b(!0),V(Ce,null,ke(e.files,r=>Q((b(),V("div",{class:d(e.classes(e.n("file"),e.n("$-elevation--2"),[r.state==="loading",e.n("--loading")])),key:r.id,onClick:u=>e.preview(r)},[S("div",{class:d(e.n("file-name"))},Be(r.name||r.url),3),e.removable?(b(),V("div",{key:0,class:d(e.n("file-close")),onClick:Se(u=>e.handleRemove(r),["stop"])},[D(m,{class:d(e.n("file-close-icon")),"var-uploader-cover":"",name:"delete"},null,8,["class"])],10,Ee)):T("v-if",!0),r.cover?(b(),V("img",{key:1,class:d(e.n("file-cover")),style:De({objectFit:r.fit}),src:r.cover,alt:r.name},null,14,He)):T("v-if",!0),S("div",{class:d(e.classes(e.n("file-indicator"),[r.state==="success",e.n("--success")],[r.state==="error",e.n("--error")]))},null,2)],10,je)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple}]])),128)),!e.maxlength||e.modelValue.length<e.maxlength?Q((b(),V("div",{key:0,class:d(e.classes([!e.$slots.default,e.n("action")+" "+e.n("$-elevation--2")],[e.disabled||e.formDisabled,e.n("--disabled")])),onClick:s[1]||(s[1]=function(){return e.triggerAction&&e.triggerAction(...arguments)})},[S("input",{ref:"input",class:d(e.n("action-input")),type:"file",multiple:e.multiple,accept:e.accept,capture:e.capture,disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly,onChange:s[0]||(s[0]=function(){return e.handleChange&&e.handleChange(...arguments)})},null,42,Oe),Te(e.$slots,"default",{},()=>[D(m,{class:d(e.n("action-icon")),"var-uploader-cover":"",name:"plus"},null,8,["class"])])],2)),[[l,{disabled:e.disabled||e.formDisabled||e.readonly||e.formReadonly||!e.ripple||e.$slots.default}]]):T("v-if",!0)],2),D(f,{"error-message":e.errorMessage,"extra-message":e.maxlengthText},null,8,["error-message","extra-message"]),D(g,{class:d(e.n("preview")),"var-uploader-cover":"",position:"center",show:e.showPreview,"onUpdate:show":s[2]||(s[2]=r=>e.showPreview=r),onClosed:s[3]||(s[3]=r=>e.currentPreview=null)},{default:Ue(()=>{var r,u;return[e.currentPreview&&e.isHTMLSupportVideo((r=e.currentPreview)==null?void 0:r.url)?(b(),V("video",{key:0,class:d(e.n("preview-video")),playsinline:"true","webkit-playsinline":"true","x5-playsinline":"true","x5-video-player-type":"h5","x5-video-player-fullscreen":"false",controls:"",src:(u=e.currentPreview)==null?void 0:u.url},null,10,We)):T("v-if",!0)]}),_:1},8,["class","show"])],2)}const z=Ve({render:Ge,name:"VarUploader",directives:{Ripple:be},components:{VarIcon:ye,VarPopup:he,VarFormDetails:ge},props:Ne,setup(e){var s=F(null),m=F(!1),f=F(null),g=q(()=>{var{maxlength:a,modelValue:{length:n}}=e;return Le(a)?n+" / "+a:""}),{form:l,bindForm:r}=ce(),{errorMessage:u,validateWithTrigger:c,validate:U,resetValidation:A}=$e(),ee=q(()=>{var{modelValue:a,hideList:n}=e;return n?[]:a}),ae=()=>{s.value.click()},re=a=>{var{disabled:n,readonly:i,previewed:t}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||n||i||!t)){var{url:o}=a;if(X(o)&&K(o)){we(o);return}X(o)&&J(o)&&(f.value=a,m.value=!0)}},le=a=>({id:Ie++,url:"",cover:"",name:a.name,file:a}),ne=a=>{var n=a.target,{files:i}=n;return Array.from(i)},ie=a=>new Promise(n=>{var i=new FileReader;i.onload=()=>{var t=i.result;a.file.type.startsWith("image")&&(a.cover=t),a.url=t,n(a)},i.readAsDataURL(a.file)}),oe=a=>a.map(ie),se=a=>{var{onBeforeRead:n}=e;return a.map(i=>new Promise(t=>{n||t({valid:!0,varFile:i});var o=p(n,B(i));o=Z(o)?o:[o],Promise.all(o).then(R=>{t({valid:!R.some(C=>!C),varFile:i})})}))},te=function(){var a=_(function*(n){var{maxsize:i,maxlength:t,modelValue:o,onOversize:R,onAfterRead:C,readonly:h,disabled:$}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||$||h)){var k=v=>v.filter(y=>y.file.size>Y(i)?(p(R,B(y)),!1):!0),ve=v=>{var y=Math.min(v.length,Y(t)-o.length);return v.slice(0,y)},me=ne(n),w=me.map(le);w=i!=null?k(w):w,w=t!=null?ve(w):w;var fe=yield Promise.all(oe(w)),pe=yield Promise.all(se(fe)),G=pe.filter(v=>{var{valid:y}=v;return y}).map(v=>{var{varFile:y}=v;return y});p(e["onUpdate:modelValue"],[...o,...G]),n.target.value="",G.forEach(v=>p(C,B(v)))}});return function(i){return a.apply(this,arguments)}}(),de=function(){var a=_(function*(n){var{disabled:i,readonly:t,modelValue:o,onBeforeRemove:R,onRemove:C}=e;if(!(l!=null&&l.disabled.value||l!=null&&l.readonly.value||i||t)){if(R){var h=p(R,B(n));if(h=Z(h)?h:[h],(yield Promise.all(h)).some(k=>!k))return}var $=o.filter(k=>k!==n);p(C,B(n)),H("onRemove"),p(e["onUpdate:modelValue"],$)}});return function(i){return a.apply(this,arguments)}}(),M=()=>e.modelValue.filter(a=>a.state==="success"),I=()=>e.modelValue.filter(a=>a.state==="error"),j=()=>e.modelValue.filter(a=>a.state==="loading"),E={getSuccess:M,getError:I,getLoading:j},H=a=>{Ae(()=>{var{validateTrigger:n,rules:i,modelValue:t}=e;c(n,a,i,t,E)})},L=!1,O=()=>U(e.rules,e.modelValue,E),W=()=>{L=!0,p(e["onUpdate:modelValue"],[]),A()},ue={validate:O,resetValidation:A,reset:W};return p(r,ue),Re(()=>e.modelValue,()=>{!L&&H("onChange"),L=!1},{deep:!0}),{n:ze,classes:Me,input:s,files:ee,showPreview:m,currentPreview:f,errorMessage:u,maxlengthText:g,isHTMLSupportVideo:J,isHTMLSupportImage:K,formDisabled:l==null?void 0:l.disabled,formReadonly:l==null?void 0:l.readonly,preview:re,triggerAction:ae,handleChange:te,handleRemove:de,getSuccess:M,getError:I,getLoading:j,validate:O,resetValidation:A,reset:W}}});z.install=function(e){e.component(z.name,z)};export{z as U};
